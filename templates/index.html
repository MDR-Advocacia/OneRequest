{% extends "base.html" %}
{% block title %}Painel de Solicitações - OneRequest{% endblock %}

{% block content %}
<section class="kpi-section">
    <div class="kpi-card vencidas">
        <h3>Vencidas</h3>
        <p>{{ kpis.vencidas }}</p>
    </div>
    <div class="kpi-card hoje">
        <h3>Vencem Hoje</h3>
        <p>{{ kpis.hoje }}</p>
    </div>
    <div class="kpi-card amanha">
        <h3>Vencem Amanhã</h3>
        <p>{{ kpis.amanha }}</p>
    </div>
    <div class="kpi-card futuras">
        <h3>Futuras</h3>
        <p>{{ kpis.futuras }}</p>
    </div>
</section>

<section class="results-section">
    <div class="chart-header">
        <h2>Recebimentos</h2>
        <span id="total-recebimentos" class="total-badge">Total: 0</span>
    </div>
    <div class="chart-container">
        <canvas id="recebimentosChart"></canvas>
    </div>
</section>

<section class="input-section">
    <h2>Filtros e Ações</h2>
    <form method="GET" action="{{ url_for('index') }}" class="filter-form" id="filter-form">
        <div class="filter-group">
            <div class="form-field">
                <label>Responsável</label>
                <select name="responsavel" class="form-control">
                    <option value="">Todos</option>
                    {% for usuario in usuarios %}
                        <option value="{{ usuario['name'] }}" {% if filters.responsavel == usuario['name'] %}selected{% endif %}>
                            {{ usuario['name'] }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-field">
                <label>Busca (Tabela)</label>
                <input type="text" name="busca" class="form-control" placeholder="Palavra-chave ou número" value="{{ filters.busca }}">
            </div>
            <div class="form-field">
                <label>Data Início (Gráfico)</label>
                <input type="date" name="data_inicio_grafico" id="data-inicio-grafico" class="form-control" value="{{ filters.data_inicio_grafico }}">
            </div>
            <div class="form-field">
                <label>Data Fim (Gráfico)</label>
                <input type="date" name="data_fim_grafico" id="data-fim-grafico" class="form-control" value="{{ filters.data_fim_grafico }}">
            </div>
        </div>
        <div class="action-group">
            <a href="{{ url_for('exportar') }}" class="action-button export">Exportar Pendentes ({{ solicitacoes|length }})</a>
            <button type="submit" class="action-button filter">Filtrar</button>
        </div>
    </form>
</section>

<section class="results-section">
    <h2>Solicitações Abertas ({{ solicitacoes|length }})</h2>
    <table class="main-table">
        <thead>
            <tr>
                <th class="col-farol">Farol</th>
                <th class="col-recebido">Recebido Em</th>
                <th class="col-solicitacao">Nº Solicitação</th>
                <th class="col-processo">Nº Processo</th>
                <th class="col-prazo">Prazo</th>
                <th class="col-polo">Polo</th>
                <th class="col-responsavel">Responsável</th>
                <th class="col-anotacao">Anotação</th>
                <th class="col-status">Status</th>
                <th class="col-dmi">Texto DMI</th>
            </tr>
        </thead>
        <tbody>
            {% if solicitacoes %}
                {% for item in solicitacoes %}
                    <tr data-id="{{ item['numero_solicitacao'] }}">
                        <td>
                            <span class="farol farol-{{ item['farol_status'] }}"></span>
                        </td>
                        <td>{{ item['recebido_em'] }}</td>
                        <td>{{ item['numero_solicitacao'] }}</td>
                        <td {% if 'não' in item['numero_processo']|lower or 'erro' in item['numero_processo']|lower %} class="status-info" {% endif %}>
                            {{ item['numero_processo'] }}
                        </td>
                        <td>{{ item['prazo'] }}</td>
                        <td>{{ item['polo'] }}</td>
                        <td>
                            <select class="form-control" name="responsavel">
                                <option value="N/A" {% if item['responsavel'] == 'N/A' %}selected{% endif %}>-- Selecione --</option>
                                {% for usuario in usuarios %}
                                    <option value="{{ usuario['name'] }}" {% if item['responsavel'] == usuario['name'] %}selected{% endif %}>
                                        {{ usuario['name'] }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control" name="anotacao" placeholder="[Anotação]" value="{{ item['anotacao'] }}">
                        </td>
                        <td>
                            <select class="form-control" name="status">
                                <option value="Não" {% if item['status'] == 'Não' %}selected{% endif %}>Não</option>
                                <option value="Sim" {% if item['status'] == 'Sim' %}selected{% endif %}>Sim</option>
                                <option value="LegalOne?" {% if item['status'] == 'LegalOne?' %}selected{% endif %}>LegalOne?</option>
                            </select>
                        </td>
                        <td><div class="texto-dmi">{{ item['texto_dmi'] }}</div></td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="10" class="no-data">Nenhuma solicitação encontrada para os filtros aplicados.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Script para salvar as alterações da tabela
        const inputs = document.querySelectorAll('tbody .form-control');
        inputs.forEach(input => {
            input.addEventListener('change', () => {
                const row = input.closest('tr');
                const id = row.dataset.id;
                const responsavel = row.querySelector('[name="responsavel"]').value;
                const anotacao = row.querySelector('[name="anotacao"]').value;
                const status = row.querySelector('[name="status"]').value;
                row.style.transition = 'background-color 0.5s ease';
                row.style.backgroundColor = 'rgba(91, 192, 222, 0.2)';
                fetch('/atualizar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json',},
                    body: JSON.stringify({
                        numero_solicitacao: id,
                        responsavel: responsavel,
                        anotacao: anotacao,
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Sucesso:', data);
                    setTimeout(() => row.style.backgroundColor = '', 500);
                })
                .catch(error => {
                    console.error('Erro:', error);
                    row.style.backgroundColor = '';
                    alert('Não foi possível salvar os dados.');
                });
            });
        });

        // Script para renderizar o gráfico
        let recebimentosChart = null; // Variável para guardar a instância do gráfico

        function renderizarGrafico() {
            const dataInicio = document.getElementById('data-inicio-grafico').value;
            const dataFim = document.getElementById('data-fim-grafico').value;
            const apiUrl = `/api/recebimentos?inicio=${dataInicio}&fim=${dataFim}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(apiData => {
                    const ctx = document.getElementById('recebimentosChart').getContext('2d');
                    document.getElementById('total-recebimentos').innerText = `Total: ${apiData.total}`;
                    
                    if(recebimentosChart) {
                        recebimentosChart.destroy();
                    }

                    recebimentosChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: apiData.labels,
                            datasets: [{
                                label: 'Solicitações Recebidas',
                                data: apiData.data,
                                backgroundColor: 'rgba(91, 192, 222, 0.6)',
                                borderColor: 'rgba(91, 192, 222, 1)',
                                borderWidth: 1,
                                borderRadius: 5
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#e0e0e0' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                x: {
                                    ticks: { color: '#e0e0e0' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            maintainAspectRatio: false
                        }
                    });
                })
                .catch(error => console.error('Erro ao buscar dados do gráfico:', error));
        }

        // Renderiza o gráfico quando a página carrega
        renderizarGrafico();

        // Atualiza o gráfico quando o formulário de filtro é submetido
        const filterForm = document.getElementById('filter-form');
        filterForm.addEventListener('submit', (event) => {
            // A página vai recarregar por causa do submit, mas podemos
            // redesenhar o gráfico com as novas datas que estarão nos campos
            // Esta chamada é um fallback, o ideal é que a página recarregue com os novos filtros
            renderizarGrafico(); 
        });
    });
</script>
{% endblock %}